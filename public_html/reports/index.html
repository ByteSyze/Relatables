<?php
	session_start();
	
	require $_SERVER['DOCUMENT_ROOT'] . '/global.php';
	
	$connection = GlobalUtils::getConnection();
	
	if(!GlobalUtils::$user->isAdmin())
	{
		header("HTTP/1.0 404 Not Found");
		die();
	}
	else
	{
		$reported_comments  = $connection->query("SELECT pid, cid, comment, (SELECT username FROM accounts WHERE id=comments.uid) AS author, (SELECT COUNT(id) FROM comment_reports WHERE comment_reports.id=comments.cid) AS reports FROM comments WHERE reported = 0 AND deleted = 0 ORDER BY reports DESC");
		$reported_posts		= $connection->query("SELECT id, submission, (SELECT username FROM accounts WHERE id=submissions.uid) AS author, (SELECT COUNT(submission_reports.id) FROM submission_reports WHERE submission_reports.id=submissions.id) AS reports FROM submissions WHERE reported = 0 AND pending = 0 ORDER BY reports DESC");
	}
?>
<!DOCTYPE html>
<!-- Copyright (C) Tyler Hackett 2014 -->
<html>
	<head>
		<title>Reported Content</title>
		
		<meta charset="UTF-8">
		<link rel="shortcut icon" href="../favicon.ico">
		<?php GlobalUtils::getCSS(); ?>
		<link rel="canonical" href="http://www.relatablez.com/">
	</head>
	<body>
		<?php require($_SERVER['DOCUMENT_ROOT']."/navigation.php"); ?>
		<div id='main'>
			<h1 id='title'>Reported Content</h1>
			<div id='reported-content'>
			
				<h3>Reported Comments:</h3>
				<div class='reported'>
					<table>
						<tr><th>Link</th><th>Author</th><th>Comment</th><th>Reports</th>
						<?php
							while($comment = $reported_comments->fetch_array())
							{
								echo "<tr><td><a href='http://www.relatablez.com/post/{$comment['pid']}#{$comment['cid']}'>{$comment['cid']}</a><td>{$comment['author']}<td>{$comment['comment']}<td>{$comment['reports']}<td class='but' data-creport='{$comment['cid']}'>Delete<td class='but' data-ckeep='{$comment['cid']}'>Keep";
							}
						?>
					</table>
				</div>
				
				<h3>Reported Posts:</h3>
				<div class='reported'>
					<table>
						<tr><th>Link</th><th>Author</th><th>Comment</th><th>Reports</th>
						<?php
							while($post = $reported_posts->fetch_array())
							{
								echo "<tr><td><a href='http://www.relatablez.com/post/{$post['id']}'>{$post['id']}</a><td>{$post['author']}<td>{$post['submission']}<td>{$post['reports']}<td class='but' data-sreport='{$post['id']}'>Delete<td class='but' data-skeep='{$post['id']}'>Keep";
							}
						?>
					</table>
				</div>
			</div>
		</div>
		<?php GlobalUtils::getJS(); ?>
		<script type='text/javascript'>
			$('[data-creport]').click(function()
			{
				cid = $(this).attr('data-creport');
				row = $(this).parent();
				
				$.post('/report.php', {c: cid}, function(){ row.remove(); });
			});
			$('[data-sreport]').click(function()
			{
				pid = $(this).attr('data-sreport');
				row = $(this).parent();
				
				$.post('/report.php', {s: pid}, function(){ row.remove(); });
			});
			$('[data-ckeep]').click(function()
			{
				cid = $(this).attr('data-ckeep');
				row = $(this).parent();
				
				$.post('/unreport.php', {c: cid}, function(){ row.remove(); });
			});
			$('[data-skeep]').click(function()
			{
				pid = $(this).attr('data-skeep');
				row = $(this).parent();
				
				$.post('/unreport.php', {s: pid}, function(){ row.remove(); });
			});
		</script>
	</body>
</html>
