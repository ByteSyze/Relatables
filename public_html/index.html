<!DOCTYPE html>
<!-- Copyright (C) Tyler Hackett 2014-->
<?php  
	require('global.php');
	
	$connection = GlobalUtils::getConnection();
	
	$page 		= intval($_GET['p']);
	$order_by 	= $_GET['o'];
	$category 	= intval($_GET['c']);
	$nsfw		= $_GET['n'];
	$display	= $GET['d'];
	
	if($order_by == 2)
		$order_by = ' ORDER BY submissions.date ASC ';
	else if($order_by == 3)
		$order_by = ' ORDER BY notalone DESC ';
	else if($order_by == 4)
		$order_by = ' ORDER BY alone DESC ';
	else
		$order_by = ' ORDER BY submissions.date DESC ';	
		
	if($display == 1)
	{
		$page *= 20;
		$end = $page+20;
		$display = " LIMIT $page, $end";
	}
	else if($display == 2)
	{
		$page *= 50;
		$end = $page+50;
		$display = " LIMIT $page, $end";
	}
	else
	{
		$page *= 20;
		$end = $page+20;
		$continuous = true;	
		$display = " LIMIT $page, $end";
	}
				
	if($nsfw == 1)
		$nsfw = '';
	else 
		$nsfw = ' AND nsfw=0 ';
	
	if($_SESSION['username'] != null)
		$submissions = mysqli_query($connection,"SELECT *, (SELECT username FROM accounts WHERE id=submissions.uid) AS author, (SELECT admin FROM accounts WHERE id=submissions.uid) AS admin, (UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(date))/60 AS date_diff, (SELECT alone FROM related WHERE related.uid={$_SESSION['id']} AND related.pid = submissions.id) AS user_vote FROM submissions WHERE pending = 0 $nsfw $order_by $display");
	else
		$submissions = mysqli_query($connection,"SELECT *, (SELECT username FROM accounts WHERE id=submissions.uid) AS author, (SELECT admin FROM accounts WHERE id=submissions.uid) AS admin, (UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(date))/60 AS date_diff FROM submissions WHERE pending = 0 $nsfw $order_by $display");
?>
<html>
	<head>
		<title>Relatablez</title>
		
		<?php 
			GlobalUtils::getMeta();
			GlobalUtils::getCSS('submissiontheme'); 
		?>
		<link rel='canonical' href='http://www.relatablez.com/'>
	</head>
	<body>		
		<?php require($_SERVER["DOCUMENT_ROOT"] . "/toolbar.php"); ?>
		
		<div id='main'>
			<div id='content' style='float:left;width:700px;'>
				
					<span style='vertical-align:bottom;'>NSFW</span><input type='checkbox' id='nsfw' style='vertical-align:bottom;'>
					<span style='vertical-align:bottom;'>Sort by</span>
					<select id='sort' style='vertical-align:bottom;'>
						<option value='0'>New-To-Old</option>
						<option value='1'>Old-To-New</option>
						<option value='2'>Highest Rated</option>
						<option value='3'>Lowest Rated</option>
					</select>
					<span style='vertical-align:bottom;'>Category</span>
					<select id='category' style='vertical-align:bottom;'>
						<option value='0'>All Categories</option>
						<option value='1'>Health</option>
						<option value='2'>Internet</option>
						<option value='3'>Funny</option>
						<option value='4'>People</option>
						<option value='5'>Family</option>
						<option value='6'>Food</option>
						<option value='7'>Personal</option>
						<option value='8'>Odd</option>
						<option value='9'>Other</option>
					</select>
					<span style='vertical-align:bottom;'>Display</span>
					<select id='display' style='vertical-align:bottom;'>
						<option value='0'>Continuously</option>
						<option value='1'>20 a page</option>
						<option value='2'>50 a page</option>
					</select>
				<div id='submission-wrapper' class='dialogue submission' style='margin-top:13px;height:71px;'>
					<?php 
						if($_SESSION['username'] !== null)
						{
							echo "<form action='http://www.relatablez.com/submit.php' method='POST' >\r\n"; 
							echo "<textarea name='s' id='submission' class='dialogue showguides'>Am I the only one who</textarea>\r\n";
						}
						else
						{
							echo "	<textarea name='s' id='submission' class='dialogue' data-signup-header='Please sign up to submit'>Am I the only one who</textarea>\r\n";
						}
					?>
						<div style='float:right'>
							<select name='c' id='submit_category'>
								<option value='0'>Select a Category</option>
								<option value='1'>Health</option>
								<option value='2'>Internet</option>
								<option value='3'>Funny</option>
								<option value='4'>People</option>
								<option value='5'>Family</option>
								<option value='6'>Food</option>
								<option value='7'>Personal</option>
								<option value='8'>Odd</option>
								<option value='9'>Other</option>
							</select>
							<span> Anonymous</span><input type='checkbox' name='a' value='true' id='anonymous' />
							<span id='post-counter'> 300 </span>
							<?php
								if($_SESSION['username'] !== null)
									echo "<button id='submit_form' class='submit-button' type='submit' ><b>Submit</b></button>";
								else
									echo "\r\n<button class='submit-button' data-header='Please sign up to submit' onclick='showRegister(this)'>Submit</button>";
							?>
						</div>
						<br>
					<?php if($_SESSION['username'] !== null) echo '</form>'; ?>
					<br><hr>
					<span class='guideline-title'><b>Guidelines:</b></span>
					<ul>
						<li>Your post must be well written and original.</li>
						<li>Your post must start with "Am I the only one" and end with a question mark.</li>
					</ul>
					<span class='guideline-title'><b>Rules:</b></span>
					<ul>
						<li>Hate speech based on race, cultural origin, beliefs, disability or sexual orientation will NOT be tolerated.</li>
					</ul>
					<b class='warning'><i>Not following the rules may result in a warning and/or your account being terminated. Please use common sense.</i></b>
				</div>
				<?php
					while($row = mysqli_fetch_array($submissions))
						GlobalUtils::parseSubmission($row);
				?>	
			</div>	
			<div style='float:right;'>
				<div id='qotw'>
					<h4 id='qotw-header'>QOTW</h4>
					<div style='padding:10px;'>
						<span>Select a test option.</span>
						<form action='http://www.relatablez.com/qotw.php' method='POST'>
							<div id='qotw-wrapper'>
								<input type='radio' name='v' value='0' />Option A.<br>
								<input type='radio' name='v' value='1' />Option B.
								<input type='submit' value='vote' id='qotw-submit' />
							</div>
						</form>
					</div>
				</div>
			</div>	
		</div>
		
		<?php GlobalUtils::getJS('index'); ?>
	</body>
</html>