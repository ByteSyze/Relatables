<!DOCTYPE html>
<!-- Copyright (C) Tyler Hackett 2014-->
<?php
	require('global.php');

	$connection = GlobalUtils::getConnection();

	//All of the following variables are pre-processed
	//and have determined values before the SQL query
	//at the end. DO NOT pass unprocessed user input to
	//the SQL query, ever.
	$page 		= intval($_GET['p']);
	$order_by 	= $_GET['o'];
	$category 	= intval($_GET['c']);
	$nsfw		= $_GET['n'];
	$display	= $GET['d'];

	if($order_by == 2)
		$order_by = ' ORDER BY submissions.date ASC ';
	else if($order_by == 3)
		$order_by = ' ORDER BY notalone DESC ';
	else if($order_by == 4)
		$order_by = ' ORDER BY alone DESC ';
	else
		$order_by = ' ORDER BY submissions.date DESC ';

	if($display == 1)
	{
		$page *= 20;
		$end = $page+20;
		$display = " LIMIT $page, $end";
	}
	else if($display == 2)
	{
		$page *= 50;
		$end = $page+50;
		$display = " LIMIT $page, $end";
	}
	else
	{
		$page *= 20;
		$end = $page+20;
		$continuous = true;
		$display = " LIMIT $page, $end";
	}

	if($nsfw == 1)
		$nsfw = '';
	else
		$nsfw = ' AND nsfw=0 ';

	if($_SESSION['username'] != null)
		$submissions = mysqli_query($connection,"SELECT *, (SELECT username FROM accounts WHERE id=submissions.uid) AS author, (SELECT admin FROM accounts WHERE id=submissions.uid) AS admin, (UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(date))/60 AS date_diff, (SELECT alone FROM related WHERE related.uid={$_SESSION['id']} AND related.pid = submissions.id) AS user_vote FROM submissions WHERE pending = 0 $nsfw $order_by $display");
	else
		$submissions = mysqli_query($connection,"SELECT *, (SELECT username FROM accounts WHERE id=submissions.uid) AS author, (SELECT admin FROM accounts WHERE id=submissions.uid) AS admin, (UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(date))/60 AS date_diff FROM submissions WHERE pending = 0 $nsfw $order_by $display");
?>
<html>
	<head>
		<title>Relatablez</title>

		<?php
			GlobalUtils::getMeta();
			GlobalUtils::getCSS('submissiontheme');
		?>
		<link rel='canonical' href='http://www.relatablez.com/'>
	</head>
	<body>
		<?php require($_SERVER["DOCUMENT_ROOT"] . "/navigation.php"); ?>
		<div class="grid wrap wider">
			<div class="unit two-thirds">
				<div class="boxes">
					<div class="box">
						<div class="box-content">
							<form>
								<textarea>Am I the only one who</textarea>
							</form>
						</div>
					</div>
					
					<div class="filters">
					</div>
					<?php
						while($row = mysqli_fetch_array($submissions))
							GlobalUtils::parseSubmission($row);
					?>
				</div>
				<div class="bottom-navigation">
					<div class="buttons">
						<a href="#" class="button">previous</a>
						<a href="#" class="button blue">1</a>
						<a href="#" class="button blue-hover">2</a>
						<a href="#" class="button blue-hover">3</a>
						<a href="#" class="button blue-hover">4</a>
						<a href="#" class="button blue-hover">5</a>
						<a href="#" class="button blue-hover">6</a>
						<a href="#" class="button blue-hover">7</a>
						<a href="#" class="button blue-hover">8</a>
						<a href="#" class="button blue-hover">next</a>
					</div>
				</div>
			</div>
			<div class="unit one-third">
				<div class="boxes">
					<div class="box">
						<span class="box-title">Quote of the Week</span>
						<div class="box-content">
							<span>Select a test option.</span>
							<form action='http://www.relatablez.com/qotw.php' method='POST'>
								<div id='qotw-wrapper'>
									<input type='radio' name='v' value='0' />Option A.<br>
									<input type='radio' name='v' value='1' />Option B.<br><br>
									<div class="buttons">
										<button class="button blue-hover" type='submit' id='qotw-submit'>Vote</button>
									</div>
								</div>
							</form>
						</div>
					</div>
					<div class="box">
						<span class="box-title">Advertisement</span>
						<div class="box-content thin">
							<img src="http://www.pinkham.com/cassel-news-parade/sites/all/themes/openpublish/images/placeholder_ad_rectangle.gif">
						</div>
					</div>
				</div>
			</div>
		</div>

		<?php GlobalUtils::getJS('index'); ?>
	</body>
</html>
