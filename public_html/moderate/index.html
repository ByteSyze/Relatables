<?php  
	/*Copyright (C) Tyler Hacket 2015*/
	
	require($_SERVER['DOCUMENT_ROOT'] . '/global.php');
	
	$connection = GlobalUtils::getConnection();

	if (mysqli_connect_errno())
	{
		echo 'Failed to connect to MySQL: ' . mysqli_connect_error();
	}	
	
	$index = $_SESSION['user']->getModerationIndex();
	
	if($_POST['v'] !== null)
	{
		if($_SESSION['id'] !== null)
		{
			$end = $index+2;
			
			$submissions = mysqli_query($connection, "SELECT submission, alone, notalone, id FROM submissions WHERE pending=1 ORDER BY submissions.date LIMIT $index, $end");
			$submission = mysqli_fetch_array($submissions); // The submission that was voted on.
			
			$alone	  = $submission['alone'];
			$notalone = $submission['notalone'];
			
			if($alone + $notalone >= 100)
			{
				//If there are atleast 1000 votes, decide the fate of the submission.
				if($notalone/$alone >= 3)
				{
					//If the yes-to-no vote ratio is atleast 3:1,
					//Send it to the front page.
					mysqli_query($connection, 'UPDATE submissions SET pending=0, alone=0, notalone=0 WHERE id='.$submission['id']);
				}
				else
				{
					//If the vast majority didn't say yes, play it safe
					//and discard it instead of posting it.
					mysqli_query($connection, 'DELETE FROM submissions WHERE id='.$submission['id']);
				}
			}
			else
			{
				if($_POST['v'] === 'Yes' || $_POST['v'] === 'NSFW')
				{
					if($_POST['v'] === 'NSFW')
						$nsfw_mysql_code = ',nsfw=nsfw+1';
						
					mysqli_query($connection, "UPDATE submissions SET notalone=notalone+1 $nsfw_mysql_code WHERE id=" . $submission['id']);
					incModerationIndex($connection, $_SESSION['id']);
				}
				else if($_POST['v'] === 'No')
				{
					mysqli_query($connection, 'UPDATE submissions SET alone=alone+1 WHERE id=' . $submission['id']);
					incModerationIndex($connection, $_SESSION['id']);
				}
			}
		}
	}
	else
	{
		$end = $index+1;
		$submissions = mysqli_query($connection, "SELECT submission, id FROM submissions WHERE pending=1 ORDER BY submissions.date LIMIT $index, $end");
	}
	
	$submission = mysqli_fetch_array($submissions);
?>
<!DOCTYPE html>
<!-- Copyright (C) Tyler Hackett 2014-->
<html>
	<head>
		<title>Moderate</title>
		<link rel='shortcut icon' href='favicon.ico'/>
		<?php GlobalUtils::getCSS(); ?>
	</head>
	<body>
		<?php require("../navigation.php"); ?>
		
		<div class="moderate-jumbo">
			<h1>Does this post obey the rules & guidelines?</h1>
			<div class="moderate-post">
				<?php echo $submission['submission'] != null
							 	 ? $submission['submission']
								 : "There are no posts to moderate at this time"; ?>
			</div>
			<form id='moderation-form' method='POST'>
				<div class="buttons moderate-buttons more-space">
	        <button class="button green large" type='submit' name='v' value='Yes'>Yes</button>
	        <button class="button yellow large" type='submit' name='v' value='NSFW'>Yes, but NSFW</button>
	        <button class="button red large" type='submit' name='v' value='No'>No</button>
      	</div>
      </form>
		</div>
		<div class="moderation-info">
			<h3>Guidelines</h3>
			<ul>
			  <li>Posts must be well written and original.</li>
			  <li>Posts must start with "Am I the only one" and end with a question mark.</li>
			</ul>
			<h3>Rules</h3>
			<ul>
			  <li>Hate speech based on race, cultural origin, beliefs, disability or sexual orientation will <b>not</b> be tolerated.</li>
			  <li>Posts should be suitable and appropriate for Relatablez users.</li>
			</ul>
		</div>

		<div class="popup" id='help-popup' class='hidden'>
        <button id='help-close' class='closebutton'></button>
        <div id='help-popup-content'>
        <h3>What Is This?</h3>
        <p>To make sure only the best posts reach the front page, we allow users like yourself to choose which posts get in. These are pending posts that have recently been submitted and are awaiting approval.</p>
        
        <h3>How Do I Moderate?</h3>
        <p>Choose <b>Yes</b> if it follows our Rules and Guidelines.</p>
        <p>Choose <b>No</b> if the post does not follow the Rules and Guidelines.</p>
        <p>Click <b>Report</b> if the post contains any of the following:</p>
        <p class='subtext'>Hate speech based on race, cultural origin, beliefs, disability or sexual orientation.</p>
        <p>If a post contains subtle swearing, or is inappropriate for younger audiences, please flag the post as <b>NSFW</b>.</p>
        </div>
      </div>

		<?php GlobalUtils::getJS(); ?>
		<script type='text/javascript'>
			$('#help-open').click(function()
			{
				$('#help-popup').toggleClass('hidden');
			});	
			$('#help-close').click(function()
			{
				$('#help-popup').addClass('hidden');
			});
		</script>
	</body>
</html>